[buildout]
extends =
    base.cfg

effective-user = plone

parts =
    zeoserver
    instance1
    instance2
    haproxy-build
    haproxy-conf
    varnish-build
    varnish-config
    varnish
    supervisor
    backup
    backup-cronjob
    zeopack-cronjob
    zopepy
    repozo

[zeoserver]
recipe = plone.recipe.zeoserver
zeo-address = 8100
effective-user = ${buildout:effective-user}
blob-storage = ${buildout:directory}/var/blobstorage

[instance1]
recipe = plone.recipe.zope2instance
http-address = 8081
user = admin:pass
zeo-client = true
zeo-address = ${zeoserver:zeo-address}
zodb-cache-size = 4000
zeo-client-cache-size = 50MB
debug-mode = off
verbose-security = off
effective-user = ${buildout:effective-user}
eggs = ${buildout:eggs}

zcml = 
    sbo.policy.deployment

environment-vars =
    zope_i18n_compile_mo_files = true
    
[instance2]
<=instance1
http-address = 8082

[haproxy-build]
recipe = plone.recipe.haproxy
target = linux26
cpu = i686
pcre = true

[haproxy-conf]
recipe = collective.recipe.template
input = ${buildout:directory}/haproxy.conf.in
output = ${buildout:directory}/etc/haproxy.conf
maxconn = 24000
effective-user = ${buildout:effective-user}
bind = 127.0.0.1:8090

[varnish-build]
recipe = zc.recipe.cmmi
url = ${varnish:download-url}

[varnish-config]
recipe = collective.recipe.template
input = varnish.vcl.in
output = ${buildout:directory}/etc/varnish.vcl
backend-host = 127.0.0.1
backend-port = 8090

[varnish]
recipe = plone.recipe.varnish
daemon = ${buildout:parts-directory}/varnish-build/sbin/varnishd
mode = foreground
config = ${varnish-config:output}
user = ${buildout:effective-user}
bind = 127.0.0.1:8888
cache-size = 96M
telnet = 6082

[supervisor]
recipe = collective.recipe.supervisor
plugins = superlance
port = 9001
user = admin
password = pass
programs =
    10 zeoserver ${zeoserver:location}/bin/runzeo true
    20 instance1 ${buildout:directory}/bin/instance1 [console] true
    20 instance2 ${buildout:directory}/bin/instance2 [console] true
    30 haproxy   ${buildout:directory}/bin/haproxy [-f ${buildout:directory}/etc/haproxy.conf -db] true
    40 varnish   ${buildout:directory}/bin/varnish true
eventlisteners =
    Memmon TICK_60 ${buildout:bin-directory}/memmon [-p instance1=200MB -p instance2=200MB]
    HttpOk1 TICK_60 ${buildout:bin-directory}/httpok [-p instance1 -t 10 http://localhost:8081/]
    HttpOk2 TICK_60 ${buildout:bin-directory}/httpok [-p instance2 -t 10 http://localhost:8082/]
groups =
    10 zeo-cluster zeoserver,instance1,instance2
    20 other       haproxy,varnish

[backup]
recipe = collective.recipe.backup
keep = 3

[backup-cronjob]
recipe = z3c.recipe.usercrontab
times = 0 3 * * *
command = ${buildout:bin-directory}/backup -q

[zeopack-cronjob]
recipe = z3c.recipe.usercrontab
times = 0 2 * * *
command = ${buildout:bin-directory}/zeopack days=31
